

'変数宣言
Public cn As New ADODB.Connection
Dim rs As Recordset
Dim sql As String

'SQLデータベース接続のおまじない
Public Sub SQL接続()
    'SQLへ接続
    Set cn = New ADODB.Connection
    'ODBC接続
    With cn
        'PT体質強化推進部サーバー
        .ConnectionString = "Provider=SQLOLEDB;" & _
                            "Data Source= MMD-LOGISTICS\SQLEXPRESS;" & _
                            "Initial Catalog=LogiRecoDB;" & _
                            "User ID=dev;" & _
                            "Password=awadmin;"
        .Open
        .CursorLocation = 3
    End With
End Sub

Sub マスタ更新()
    Sheets("PITマスタ").Activate
    Range("N6:R15000").ClearContents
    Call SQL接続
    sql = "SELECT BASE_NM FROM TBM_BASE WHERE BASE_CD='" & Sheets("PITマスタ").Range("B3").Value & "'"
    Set rs = cn.Execute(sql)
    If rs.RecordCount > 0 Then
        Sheets("PITマスタ").Cells(2, 2) = rs(0)
    End If
    
    sql = "SELECT MAX(LINE_DATE) FROM TBM_WORK WHERE BASE_CD='" & Sheets("PITマスタ").Range("B3").Value & "' AND LINE_DATE <='" & Sheets("PITマスタ").Range("D3").Value & "'"
    Set rs = cn.Execute(sql)
    If rs.RecordCount > 0 Then
        稼働日 = rs(0)
    Else
        MsgBox ("マスタデータが存在しません")
    End If
    
    
    sql = "SELECT TRIM(B.KOTEI_NM),TRIM(A.WORK_NM),A.KOTEI_ID,A.WORK_ID,A.TYOKU FROM TBM_WORK A INNER JOIN TBM_KOTEI B ON A.BASE_CD=B.BASE_CD AND A.KOTEI_ID=B.KOTEI_ID WHERE " & _
            "A.BASE_CD='" & Sheets("PITマスタ").Range("B3").Value & "' AND A.LINE_DATE='" & 稼働日 & "' ORDER BY KOTEI_ID,WORK_ID"
    Set rs = cn.Execute(sql)
    If rs.RecordCount > 0 Then
        Sheets("PITマスタ").Range("N6").CopyFromRecordset rs
    End If
    Range("A1").Select
End Sub

Sub 実績読込み()
    Sheets("実績").Activate
    Range("B2:F15000").ClearContents
    Sheets("評価シート").Activate
    稼働日 = Range("J3").Text
    
    Call SQL接続
    sql = "SELECT KOTEI_ID,WORK_ID,JISEKI_DT,JISEKI_DT2,TYOKU FROM TBD_JISEKI WHERE BASE_CD='" & Sheets("PITマスタ").Range("B3").Value & "' AND LINE_DATE='" & 稼働日 & "' ORDER BY SEQ"
    Set rs = cn.Execute(sql)
    If rs.RecordCount > 0 Then
        Sheets("実績").Activate
        Range("B2").CopyFromRecordset rs
        Columns("D:E").Select
        Selection.NumberFormatLocal = "yyyy/m/d h:mm:ss"
    End If
    Sheets("評価シート").Activate
End Sub

Sub 評価実行()
    Call マスタ更新
    Call 実績読込み
End Sub

